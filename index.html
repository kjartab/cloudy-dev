<html>
<head>
	<title>Cloudy</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="stylesheet" href="css/leaflet.css"/>
	<link rel="stylesheet" href="css/leaflet.draw.css"/>
	<link rel="stylesheet" href="css/bootstrap.css">
	<link rel="stylesheet" href="css/main.css">
	
</head>

<body>

	<script src="js/kartan.js"></script>
	<script src="js/leaflet.js"></script>
	<script src="js/leaflet.draw.js"></script>
	<script src="js/jquery.min.js"></script>    
	<script src="js/langeland.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="config.js"></script>
	
	<div id="header" class="navbar-default navbar-fixed-top">
		<div class="navbar-header col-md-2" >
			<a class="navbar-brand" href="#">Cloudy-dev</a>
		</div>
		<div class="collapse navbar-collapse">
			<ul class="nav navbar-nav">
				<li><a href="#"></a></li>
			</ul>
		</div>
	</div>
	<div id="wrapper">
		<div id="sidebar" class="col-lg-2">
			<ul class="nav list-group" id="resultlist">
			
			</ul>
		</div>
	 
	
		<div id="main-wrapper" class="col-lg-10">
			
			<div id="map"></div>
			
		</div>
	
	</div>

	<script> 
    
    
    
    
    var map = L.map('map').setView([61, 5], 12);
		L.tileLayer('http://www.webatlas.no/maptiles/tiles/webatlas-standard-vektor/wa_grid/{z}/{x}/{y}.png', {
            maxZoom: 20,
            zIndex: 0
        }).addTo(map);
        
        
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    var drawControl = new L.Control.Draw({
        edit : {
        featureGroup : drawnItems
        }
    });
    
    map.addControl(drawControl);
    
    map.on('draw:created', function(e) {
            var type = e.layerType;
            var layer = e.layer;
			if (type === 'rectangle' || type === 'polygon') {
				startViewer(toWKT(e.layer),-1,'polygon',-1);
			}
			
    });

    function createPolygonFromBounds(latLngBounds) {
        var center = latLngBounds.getCenter()
        latlngs = [];

        latlngs.push(latLngBounds.getSouthWest());//bottom left
        latlngs.push({ lat: latLngBounds.getSouth(), lng: center.lng });//bottom center
        latlngs.push(latLngBounds.getSouthEast());//bottom right
        latlngs.push({ lat: center.lat, lng: latLngBounds.getEast() });// center right
        latlngs.push(latLngBounds.getNorthEast());//top right
        latlngs.push({ lat: latLngBounds.getNorth(), lng: map.getCenter().lng });//top center
        latlngs.push(latLngBounds.getNorthWest());//top left
        latlngs.push({ lat: map.getCenter().lat, lng: latLngBounds.getWest() });//center left

        return new L.polygon(latlngs);
    }
    
    var  geoJsonLayer =  L.geoJson(null).addTo(map);
	
    var request; 
    map.on('moveend', function(e) {
        console.log(toWKT(createPolygonFromBounds(map.getBounds())));
        
        
        request = $.getJSON('http://10.0.0.249/datapi/pointclouds/patchesbbox/?outline='+toWKT(createPolygonFromBounds(map.getBounds())), function (data) {
		
        geoJsonLayer.clearLayers();
		for (var i=0; i<data.length; i++) {
           geoJsonLayer.addData(JSON.parse(data[i][1]));
//            geoJsonLayer.addData(JSON.parse(data[1]));	
		}
		
	});
        
    });
    
	
	
	function buildParameters(id, outline) {
		
		var params = '';
		params += 'id='+id;
		params += '&outline='+outline;
		
		return params;
	}
    
    
    function startViewer(outline, id, option, extra) {
		if(outline != null) {
			console.log(extra);
			open("viewer.html?outline="+outline+"&id="+id+"&option="+option+"&extra="+extra);
		} else {
			window.alert("No point cloud selected");
		}
	}
    
    function toWKT(layer) {
		var lng, lat, coords = [];
		
		if (layer instanceof L.Polygon || layer instanceof L.Polyline ) {
			var latlngs = layer.getLatLngs();
			for (var i = 0; i < latlngs.length; i++) {
				latlngs[i]
				coords.push(latlngs[i].lng + " " + latlngs[i].lat);
				if (i === 0) {
					lng = latlngs[i].lng;
					lat = latlngs[i].lat;
				}
			};
			if (layer instanceof L.Polygon) {
				return "POLYGON((" + coords.join(",") + "," + lng + " " + lat + "))";
			} else if (layer instanceof L.Polyline) {
				return "LINESTRING(" + coords.join(",") + ")";
			}
		} else if (layer instanceof L.Circle) {
			return "ST_MakePoint(" + layer.getLatLng().lng + "," + layer.getLatLng().lat + ")";
		} else if (layer instanceof L.Marker) {
			return "POINT(" + layer.getLatLng().lng + " " + layer.getLatLng().lat + ")";
		}
	}

	

	
	</script>


</body>

</html>

